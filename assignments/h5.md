# h5 - Miniprojekti

**Tekniset tiedot:**
- Tietokone: HP EliteDesk 800 G3 DM 35W
- Käyttöjärjestelmä: Ubuntu 24.04.2 LTS
- Prosessori: Intel® Core™ i5-7500T × 4

Tehtävänanto: [https://terokarvinen.com/palvelinten-hallinta/#h5-miniprojekti](https://terokarvinen.com/palvelinten-hallinta/#h5-miniprojekti)
   
## a) Oma miniprojekti - Event Driven Automation (SaltStack)

**Repon luonti ja kloonaus**

Loin GitHubiin uuden repositorion nimeltä h5-moduuli ja kloonasin sen omalle koneelleni:

<pre>
$ git clone git@github.com:HMJ3/h5-moduuli.git
</pre>

**Tiedostojen ja kansioiden luominen**

<pre>
$ micro init.sls
$ mkdir -p services/nginx
$ cd services/nginx
$ micro beacons.conf
$ micro index.html
$ micro nginx.conf
$ mkdir reactor
$ cd reactor
$ micro reactor.conf
$ micro recovery.sls
</pre>

Lopputulos:

![tree](https://github.com/HMJ3/linux-course/blob/main/assignments/img/h5-img/tree.png)

## Aloitetaan tiedostojen konfigurointi

**init.sls**

Tämä tiedosto asentaa nginxin, kopioi konfiguraatiotiedostot oikeisiin paikkoihin, 
varmistaa että nginx-palvelu on käynnissä ja ottaa käyttöön beaconin tilan seurantaan.

Nginxin konfigurointiin ja index.html sivuun käytin perustietoja, eli nämä eivät poikkea millään tavalla niistä tiedostia jotka luodaan perusasennuksen yhteydessä!

```
nginx:
  pkg.installed

/etc/nginx/nginx.conf:
  file.managed:
    - source: salt://h5-moduuli/services/nginx/nginx.conf

/var/www/html/index.nginx-debian.html:
  file.managed:
    - source: salt://h5-moduuli/services/nginx/index.html

nginx_service:
  service.running:
    - name: nginx
    - enable: True
    - watch:
      - file: /etc/nginx/nginx.conf
      - file: /var/www/html/index.nginx-debian.html

/etc/salt/minion.d/beacons.conf:
  file.managed:
    - source: salt://h5-moduuli/services/nginx/beacons.conf
    - makedirs: True
    - require:
      - pkg: nginx

salt_minion_id_restart:
  cmd.wait:
    - name: salt-call --local service.restart salt-minion
    - bg: true
    - order: last
    - watch:
      - file: /etc/salt/minion.d/beacons.conf
```

**beacons.conf**

 Tämä konfiguraatio ottaa käyttöön beaconin joka seuraa nginx palvelun tilaa ja lähettää tapahtuman jos tila muuttuu.

```
beacons:
  service:
    - services:
        nginx:
          onchangeonly: True
    - disable_during_state_run: True
```

**Ongelma**

Alkuun ajoin init.sls tiedoston ilman "salt_minion_id_restart:" osioa.

Tällöin asennus onnistui, mutta beacon ei mennyt päälle, alla kuva. 

![no-beacon](https://github.com/HMJ3/linux-course/blob/main/assignments/img/h5-img/no-beacon.png)

Tämä vaatii siis salt-minionin uudelleenkäynnistyksen.

Aluksi yritin käynnistää salt-minion palvelun uudelleen käyttämällä perinteistä Saltin service.running tilaa

```
restart_salt_minion:
  service.running:
    - name: salt-minion
    - watch:
      - file: /etc/salt/minion.d/beacons.conf
```

Tämä johti kuitenkin virheilmoitukseen "Minion did not return". Tämä tapahtui  koska minion sammui ja yhteys masteriin katkesi kesken tilan suorituksen.

Tämän jälkeen käytin vaihtoehtoista lähestymistapaa joka toimi ongelmitta:

```
salt_minion_id_restart:
  cmd.wait:
    - name: salt-call --local service.restart salt-minion
    - bg: true
    - order: last
    - watch:
      - file: /etc/salt/minion.d/beacons.conf
```

Tämä skripti suorittaa komennon paikallisesti minionilla (--local), taustalla (bg: true) ja vasta lopuksi (order: last) 
jolloin state tiedosto suoritetaan loppuun ilman keskeytyksiä. Muilla oli samoja ongelmia, löysin Redditistä tähän ratkaisun. (Katso lähteet)

Nyt ajo onnistui ja beacon lähti päälle.

Kun suljin nginxin manuaalisesti minionilla, näkyy beaconin luomat ilmoitukset salt masterilla:

Voit monitoroida event-bussia masterilla komennolla:

<pre>
$ salt-run state.event pretty=true
</pre>

![beacon-result](https://github.com/HMJ3/linux-course/blob/main/assignments/img/h5-img/beacon-result.png)

---

### Reactorin konfigurointi

**reactor.conf**

Masterilla sijaitseva tiedosto joka määrittelee kun nginx palvelun tila muuttuu, salt-master suorittaa recovery.sls tiedoston.

```
reactor:
  - salt/beacon/*/service/nginx:
    - /srv/salt/h5-moduuli/reactor/recovery.sls
```

**recovery.sls**

Jos nginx palvelu on pysähtynyt tämä tiedosto käynnistää sen uudelleen ja kirjaa tapahtuman järjestelmälokiin.

```
{% set minion_id = data['id'] %}
{% if data['nginx']['running'] == False %}

restart_nginx:
  local.cmd.run:
    - tgt: {{ minion_id }}
    - arg:
      - systemctl restart nginx
    - kwarg:
        timeout: 10

log_restart:
  local.cmd.run:
    - tgt: {{ minion_id }}
    - arg:
      - logger "Nginx stopped and was automatically restarted by Salt master"

{% endif %}
```

---

**Testaus**

## b) Etusivun ja ohjeiden suunnittelu

Halusin tehdä projektini etusivusta mahdollisimman selkeän ja informatiivisen. Tästä syystä päädyin tekemään uuden GitHub repon.
Tavoitteena oli että kuka tahansa sivulle tuleva ymmärtää mitä projektini tekee, miten se otetaan käyttöön, ja saa siitä yleiskuvan ilman skrollausta.

Alkuun tiivistys:

"This SaltStack module automates the setup and monitoring of an nginx service. 
It installs and configures nginx, sets up a Salt beacon to monitor its status. It uses Salt reactor to automatically restart nginx if it stops."

Tämä tiivistää nopeasti mistä projektissa on kyse.

Tein ohjeet joiden avulla moduulin saa käyttöön omalle koneelle.

![setup-1](https://github.com/HMJ3/linux-course/blob/main/assignments/img/h5-img/setup-1.png)

Valitsin lisenssiksi GNU GPL v3 koska se on yleinen avoimen lähdekoodin lisenssi.

Lisäsin myös linkin tähän raporttiin.

# Lähteet
- VMware Inc. Salt Project, Beacons. Luettavissa: https://docs.saltproject.io/en/latest/topics/beacons/
- VMware Inc. Salt Project, Reactor system. Luettavissa: https://docs.saltproject.io/en/latest/topics/reactor/index.html
- ChatGpt "Show me an example of a salt reactor file"
- ChatGpt "Show me an example of a salt beacon file"
- ChatGpt "Explain saltstack reacor and beacon functionality"
- Video "Event-Driven Automation with SaltStack Reactor and Beacons - SaltStack - SaltConf17" Katsottavissa: https://www.youtube.com/watch?v=dU-xSLWriss
- Kotitehtävä. h4-pkg file service. Luettavissa: https://github.com/HMJ3/linux-course/blob/main/assignments/h4.md
- Reddit. Restart-minion. Luettavissa: https://www.reddit.com/r/saltstack/comments/139zjk9/reloading_saltminion_configuration_without/


