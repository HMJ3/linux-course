# h5 - Miniprojekti

**Tekniset tiedot:**
- Tietokone: HP EliteDesk 800 G3 DM 35W
- Käyttöjärjestelmä: Ubuntu 24.04.2 LTS
- Prosessori: Intel® Core™ i5-7500T × 4

Tehtävänanto: [https://terokarvinen.com/palvelinten-hallinta/#h5-miniprojekti](https://terokarvinen.com/palvelinten-hallinta/#h5-miniprojekti)
    
Lähde: ([Karvinen 2018](https://terokarvinen.com/2018/04/03/pkg-file-service-control-daemons-with-salt-change-ssh-server-port/?fromSearch=karvinen%20salt%20ssh))

## a) Oma miniprojekti - Event Driven Automation (SaltStack)

**Tavoite:**
Tavoitteeni on automatisoida nginx-palvelun asennus ja valvonta SaltStackin avulla.
Tarkoituksena on asentaa ja konfiguroida nginx, ottaa käyttöön Saltin beacon sen tilan seuraamiseksi sekä 
hyödyntää Saltin reaktoria nginxin automaattiseen uudelleenkäynnistykseen, mikäli se pysähtyy.

Aloitan luomalla uuden reposetoryn GitHubiin, nimeltä "h5-moduuli".

Kloonaan tämän repon omalle koneelleni

<pre>
$ git clone git@github.com:HMJ3/h5-moduuli.git
</pre>

Tämän jälkeen loin tarvittavat kansiot ja tiedostot:

<pre>
$ micro init.sls
</pre>

init.sls sisältö:

```
nginx:
  pkg.installed

/etc/nginx/nginx.conf:
  file.managed:
    - source: salt://h5-moduuli/services/nginx/nginx.conf

/var/www/html/index.nginx-debian.html:
  file.managed:
    - source: salt://h5-moduuli/services/nginx/index.html

nginx_service:
  service.running:
    - name: nginx
    - enable: True
    - watch:
      - file: /etc/nginx/nginx.conf
      - file: /var/www/html/index.nginx-debian.html

#Beacon config
/etc/salt/minion.d/beacons.conf:
  file.managed:
    - source: salt://h5-moduuli/services/nginx/beacons.conf
    - makedirs: True
    - require:
      - pkg: nginx

salt_minion_id_restart:
  cmd.wait:
    - name: salt-call --local service.restart salt-minion
    - bg: true
    - order: last
    - watch:
      - file: /etc/salt/minion.d/beacons.conf
```

recovery.sls sisältö:

```
{% set minion_id = data['id'] %}
    {% if data['nginx']['running'] == False %}
    
    restart_nginx:
      local.cmd.run:
        - tgt: {{ minion_id }}
        - arg:
          - systemctl restart nginx
        - kwarg:
            timeout: 10
    
    log_restart:
      local.cmd.run:
        - tgt: {{ minion_id }}
        - arg:
          - logger "Nginx stopped and was automatically restarted by Salt master"
    
    {% endif %}
```


<pre>
$ mkdir reactor
$ cd reactor 
$ micro reactor.conf 
$ micro recovery.sls
</pre>

reactor.conf sisältö:

```
reactor:
  - salt/beacon/*/service/nginx:
    - /srv/salt/h5-moduuli/reactor/recovery.sls
```

recovery.sls sisältö:

```
{% set minion_id = data['id'] %}
    {% if data['nginx']['running'] == False %}
    
    restart_nginx:
      local.cmd.run:
        - tgt: {{ minion_id }}
        - arg:
          - systemctl restart nginx
        - kwarg:
            timeout: 10
    
    log_restart:
      local.cmd.run:
        - tgt: {{ minion_id }}
        - arg:
          - logger "Nginx stopped and was automatically restarted by Salt master"
    
    {% endif %}
```

Ja seuraavat

<pre> 
$ mkdir services/nginx
$ cd /services/nginx/
$ micro beacons.conf
$ micro index.html
$ micro nginx.conf
</pre>

becons.conf sisältö:

```
beacons:
  service:
    - services:
        nginx:
          onchangeonly: True
    - disable_during_state_run: True
```


index.html ja nginx.conf sisältö ei poikkea millään tavalla nginx perusasennuksesta.

N


**Kuva:**
![Apache2-Installed](https://github.com/HMJ3/linux-course/blob/main/assignments/img/h4-img/Apache2-Installed.png)

```html
<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <title>Testisivu</title>
</head>
<body>
    <h1>Tervetuloa testisivulle!</h1>
    <p>Tämä sivu toimii Apache-palvelimen kautta.</p>
</body>
</html>
```


Alla lähteet......
# Lähteet
- Karvinen. T.  SSH Luettavissa: https://terokarvinen.com/2018/04/03/pkg-file-service-control-daemons-with-salt-change-ssh-server-port/
