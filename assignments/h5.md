# h5 - Miniprojekti

**Tekniset tiedot:**
- Tietokone: HP EliteDesk 800 G3 DM 35W
- Käyttöjärjestelmä: Ubuntu 24.04.2 LTS
- Prosessori: Intel® Core™ i5-7500T × 4

Tehtävänanto: [https://terokarvinen.com/palvelinten-hallinta/#h5-miniprojekti](https://terokarvinen.com/palvelinten-hallinta/#h5-miniprojekti)
   
## a) Oma miniprojekti - Event Driven Automation (SaltStack)

**Repon luonti ja kloonaus**

Loin GitHubiin uuden repositorion nimeltä h5-moduuli ja kloonasin sen omalle koneelleni:

<pre>
$ git clone git@github.com:HMJ3/h5-moduuli.git
</pre>

**Tiedostojen ja kansioiden luominen**

<pre>
$ micro init.sls
$ mkdir -p services/nginx
$ cd services/nginx
$ micro beacons.conf
$ micro index.html
$ micro nginx.conf
$ mkdir reactor
$ cd reactor
$ micro reactor.conf
$ micro recovery.sls
</pre>

Lopputulos:

![file-structure](https://github.com/HMJ3/linux-course/blob/main/assignments/img/h5/file-structure)

##Aloitetaan tiedostojen konfigurointi**

**init.sls**

Tämä tiedosto asentaa nginxin, kopioi konfiguraatiotiedostot oikeisiin paikkoihin, 
varmistaa että nginx-palvelu on käynnissä ja ottaa käyttöön beaconin tilan seurantaan.

Nginxin konfigurointiin ja index.html sivuun käytin perustietoja, eli nämä eivät poikkea millään tavalla perusasennuksesta!

```
nginx:
  pkg.installed

/etc/nginx/nginx.conf:
  file.managed:
    - source: salt://h5-moduuli/services/nginx/nginx.conf

/var/www/html/index.nginx-debian.html:
  file.managed:
    - source: salt://h5-moduuli/services/nginx/index.html

nginx_service:
  service.running:
    - name: nginx
    - enable: True
    - watch:
      - file: /etc/nginx/nginx.conf
      - file: /var/www/html/index.nginx-debian.html

/etc/salt/minion.d/beacons.conf:
  file.managed:
    - source: salt://h5-moduuli/services/nginx/beacons.conf
    - makedirs: True
    - require:
      - pkg: nginx

salt_minion_id_restart:
  cmd.wait:
    - name: salt-call --local service.restart salt-minion
    - bg: true
    - order: last
    - watch:
      - file: /etc/salt/minion.d/beacons.conf
```

**beacons.conf**

 Tämä konfiguraatio ottaa käyttöön beaconin joka seuraa nginx-palvelun tilaa ja lähettää tapahtuman jos tila muuttuu.

```
beacons:
  service:
    - services:
        nginx:
          onchangeonly: True
    - disable_during_state_run: True
```

**reactor.conf**

 Masterilla sijaitseva tiedosto joka määrittelee kun nginx-palvelun tila muuttuu, Salt master suorittaa recovery.sls-tiedoston.

```
reactor:
  - salt/beacon/*/service/nginx:
    - /srv/salt/h5-moduuli/reactor/recovery.sls
```

**recovery.sls*

Jos nginx-palvelu on pysähtynyt, tämä tiedosto käynnistää sen uudelleen ja kirjaa tapahtuman järjestelmälokiin.

```
{% set minion_id = data['id'] %}
{% if data['nginx']['running'] == False %}

restart_nginx:
  local.cmd.run:
    - tgt: {{ minion_id }}
    - arg:
      - systemctl restart nginx
    - kwarg:
        timeout: 10

log_restart:
  local.cmd.run:
    - tgt: {{ minion_id }}
    - arg:
      - logger "Nginx stopped and was automatically restarted by Salt master"

{% endif %}
```



**Kuva:**
![Apache2-Installed](https://github.com/HMJ3/linux-course/blob/main/assignments/img/h4-img/Apache2-Installed.png)

```
html
```


Alla lähteet......
# Lähteet
- Karvinen. T.  SSH Luettavissa: https://terokarvinen.com/2018/04/03/pkg-file-service-control-daemons-with-salt-change-ssh-server-port/
